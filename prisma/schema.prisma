// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// ============================================
// Generator & Datasource
// ============================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============================================
// Domain Schemas
// ============================================
// This file is auto-generated by merge-schemas.js
// DO NOT EDIT THIS FILE DIRECTLY
// Edit the files in prisma/schemas/ instead and run: npm run schema:merge
// ============================================


// ============================================
// From: chat.prisma
// ============================================

// ============================================
// Chat Domain - Chat Room
// ============================================

// 채팅방 모델
model ChatRoom {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String?  // 그룹 채팅방 이름 (1:1 채팅은 null)
  type        ChatRoomType @default(ONE_TO_ONE) // 1:1 또는 그룹
  avatar      String?  // 채팅방 이미지
  lastMessage String?  // 마지막 메시지 미리보기
  lastMessageAt DateTime? // 마지막 메시지 시간
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 관계 (MongoDB는 참조만 저장)
  participants UserChatRoom[]
  messages     Message[]

  @@map("chat_rooms")
}

enum ChatRoomType {
  ONE_TO_ONE  // 1:1 채팅
  GROUP       // 그룹 채팅
}

// 사용자-채팅방 관계 (다대다)
model UserChatRoom {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  chatRoomId  String   @db.ObjectId
  role        ChatRoomRole @default(PARTICIPANT) // 역할 (생성자, 관리자, 참여자)
  unreadCount Int      @default(0) // 읽지 않은 메시지 수
  lastReadAt  DateTime? // 마지막으로 읽은 시간
  isMuted     Boolean  @default(false) // 알림 음소거 여부
  joinedAt    DateTime @default(now()) // 참여 시간
  leftAt      DateTime? // 나간 시간 (null이면 아직 참여 중)

  // 관계 (MongoDB는 참조만 저장)
  user     User     @relation(fields: [userId], references: [id])
  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])

  @@unique([userId, chatRoomId])
  @@index([userId])
  @@index([chatRoomId])
  @@map("user_chat_rooms")
}

enum ChatRoomRole {
  CREATOR     // 생성자
  ADMIN       // 관리자
  PARTICIPANT // 일반 참여자
}



// ============================================
// From: message.prisma
// ============================================

// ============================================
// Message Domain
// ============================================

// 메시지 모델
model Message {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  chatRoomId  String      @db.ObjectId
  senderId    String      @db.ObjectId
  content     String?     // 텍스트 메시지
  messageType MessageType @default(TEXT)
  fileUrl     String?     // 파일 URL (이미지, 동영상, 문서 등)
  fileName    String?     // 파일명
  fileSize    Int?        // 파일 크기 (bytes)
  isEdited    Boolean     @default(false) // 수정 여부
  isDeleted   Boolean     @default(false) // 삭제 여부
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // 관계 (MongoDB는 참조만 저장)
  chatRoom   ChatRoom     @relation(fields: [chatRoomId], references: [id])
  sender     User         @relation(fields: [senderId], references: [id])

  @@index([chatRoomId, createdAt])
  @@index([senderId])
  @@map("messages")
}

enum MessageType {
  TEXT        // 텍스트
  IMAGE       // 이미지
  VIDEO       // 동영상
  AUDIO       // 음성 메시지
  FILE        // 파일
  LOCATION    // 위치
  CONTACT     // 연락처
}


// ============================================
// From: user.prisma
// ============================================

// ============================================
// User Domain
// ============================================

// 사용자 모델
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  username  String   @unique
  email     String?  @unique
  phone     String?  @unique
  name      String?
  avatar    String?  // 프로필 이미지 URL
  status    String?  // 상태 메시지 (예: "온라인", "오프라인")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 관계 (MongoDB는 참조만 저장)
  chatRooms UserChatRoom[]
  messages  Message[]

  @@map("users")
}
